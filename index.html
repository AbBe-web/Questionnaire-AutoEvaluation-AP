<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√©-consultation ‚Äì Activit√© Physique</title>

<style>
body { font-family: Arial, sans-serif; background:#f6f7f8; margin:0; }
.container { max-width:720px; margin:auto; padding:20px; background:white; min-height:100vh; }
h1,h2,h3 { font-weight:600; margin-top:25px; }
.btn { display:block; width:100%; padding:14px; margin:10px 0; font-size:16px; border-radius:6px; border:none; background:#007BFF; color:white; cursor:pointer; }
.btn.secondary { background:#6c757d; }
.progress { height:6px; background:#ddd; margin:15px 0; }
.progress-bar { height:6px; width:0%; background:#4caf50; }
.footer { font-size:12px; color:#666; margin-top:40px; }
input { width:100%; padding:10px; font-size:16px; margin-top:8px; }
label { font-weight:600; display:block; margin-top:10px; }
</style>
</head>

<body>
<div class="container" id="app"></div>

<script>
/*************************************************
 * √âTAT GLOBAL
 *************************************************/
const state = {
  tool: null,
  gpaq: {},
  marshall: {},
  result: {},
  history: []
};

/*************************************************
 * RENDER + RETOUR
 *************************************************/
function render(html, progress=0, save=true){
  if(save) state.history.push(document.getElementById("app").innerHTML);
  document.getElementById("app").innerHTML = `
    <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
    ${html}
  `;
}
function back(){
  if(state.history.length>0){
    document.getElementById("app").innerHTML = state.history.pop();
  }
}

/*************************************************
 * ACCUEIL
 *************************************************/
render(`
<h1>Activit√© physique</h1>
<p>Questionnaire destin√© √† pr√©parer votre consultation m√©dicale.<br>
Aucune donn√©e n‚Äôest enregistr√©e.</p>

<p style="font-size:12px">
<a href="https://abbe-web.github.io/Questionnaire-AutoEvaluation-AP/politique-confidentialite.html" target="_blank">
Politique de confidentialit√©
</a>
</p>

<button class="btn" onclick="start('gpaq')">Questionnaire d√©taill√© (GPAQ)</button>
<button class="btn secondary" onclick="start('marshall')">Questionnaire court (Marshall)</button>
`,0,false);

function start(tool){
  state.tool = tool;
  state.gpaq = {};
  state.marshall = {};
  state.result = {};
  state.history = [];
  tool==="marshall" ? marshallQ1() : gpaqQ1();
}

/*************************************************
 * MARSHALL
 *************************************************/
function marshallQ1(){
render(`
<h2>Marshall ‚Äì Question 1</h2>
<p>Combien de fois par semaine faites-vous au moins 20 minutes d‚Äôactivit√© intense ?</p>
<button class="btn" onclick="state.marshall.q1=4; marshallQ2()">‚â• 3 fois</button>
<button class="btn" onclick="state.marshall.q1=2; marshallQ2()">1‚Äì2 fois</button>
<button class="btn" onclick="state.marshall.q1=0; marshallQ2()">Jamais</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,15);
}

function marshallQ2(){
render(`
<h2>Marshall ‚Äì Question 2</h2>
<p>Combien de fois par semaine faites-vous au moins 30 minutes d‚Äôactivit√© mod√©r√©e ou de marche rapide ?</p>
<button class="btn" onclick="finishMarshall(4)">‚â• 5 fois</button>
<button class="btn" onclick="finishMarshall(2)">3‚Äì4 fois</button>
<button class="btn" onclick="finishMarshall(1)">1‚Äì2 fois</button>
<button class="btn" onclick="finishMarshall(0)">Jamais</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,30);
}

function finishMarshall(q2){
  state.marshall.q2=q2;
  const score=state.marshall.q1+q2;
  state.result.niveau=score>=4?"suffisamment_actif":"insuffisamment_actif";
  state.result.marshall_score=score;
  motivation();
}

/*************************************************
 * GPAQ ‚Äî TEXTE EXACT FOURNI
 *************************************************/
function gpaqQ1(){
render(`
<h2>Activit√© au travail</h2>
<p>Votre travail implique-t-il des activit√©s physiques intenses ?</p>
<button class="btn" onclick="state.gpaq.wi=1; gpaqQ2()">Oui</button>
<button class="btn" onclick="state.gpaq.wi=0; gpaqQ4()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,10);
}

function gpaqQ2(){
render(`
<h2>Activit√© au travail ‚Äì intense</h2>
<label>Combien de jours par semaine faites-vous ces activit√©s ?</label>
<input type="number" min="0" max="7" onchange="state.gpaq.wi_d=this.value">
<label>Combien d‚Äôheures et minutes par jour ?</label>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.wi_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.wi_m=this.value">
<button class="btn" onclick="gpaqQ4()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,20);
}

function gpaqQ4(){
render(`
<h2>Activit√© mod√©r√©e au travail</h2>
<p>Votre travail implique-t-il des activit√©s physiques mod√©r√©es ?</p>
<button class="btn" onclick="state.gpaq.wm=1; gpaqQ5()">Oui</button>
<button class="btn" onclick="state.gpaq.wm=0; gpaqQ7()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,30);
}

function gpaqQ5(){
render(`
<h2>Activit√© mod√©r√©e au travail</h2>
<label>Combien de jours par semaine faites-vous ces activit√©s ?</label>
<input type="number" min="0" max="7" onchange="state.gpaq.wm_d=this.value">
<label>Combien d‚Äôheures et minutes par jour ?</label>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.wm_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.wm_m=this.value">
<button class="btn" onclick="gpaqQ7()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,40);
}

function gpaqQ7(){
render(`
<h2>D√©placements</h2>
<p>Effectuez-vous des trajets d‚Äôau moins 10 minutes √† pied ou √† v√©lo ?</p>
<button class="btn" onclick="state.gpaq.tr=1; gpaqQ8()">Oui</button>
<button class="btn" onclick="state.gpaq.tr=0; gpaqQ10()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,50);
}

function gpaqQ8(){
render(`
<h2>D√©placements</h2>
<label>Combien de jours par semaine ?</label>
<input type="number" min="0" max="7" onchange="state.gpaq.tr_d=this.value">
<label>Combien de temps y consacrez-vous par jour ?</label>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.tr_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.tr_m=this.value">
<button class="btn" onclick="gpaqQ10()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,60);
}

function gpaqQ10(){
render(`
<h2>Activit√© de loisirs</h2>
<p>Pratiquez-vous des sports ou du fitness de forte intensit√© ?</p>
<button class="btn" onclick="state.gpaq.li=1; gpaqQ11()">Oui</button>
<button class="btn" onclick="state.gpaq.li=0; gpaqQ13()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,70);
}

function gpaqQ11(){
render(`
<h2>Loisirs ‚Äì activit√© intense</h2>
<label>Combien de jours par semaine ?</label>
<input type="number" min="0" max="7" onchange="state.gpaq.li_d=this.value">
<label>Combien de temps y consacrez-vous par jour ?</label>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.li_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.li_m=this.value">
<button class="btn" onclick="gpaqQ13()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,80);
}

function gpaqQ13(){
render(`
<h2>Activit√© de loisirs</h2>
<p>Pratiquez-vous des activit√©s physiques mod√©r√©es en loisirs ?</p>
<button class="btn" onclick="state.gpaq.lm=1; gpaqQ14()">Oui</button>
<button class="btn" onclick="state.gpaq.lm=0; gpaqQ16()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,85);
}

function gpaqQ14(){
render(`
<h2>Loisirs ‚Äì activit√© mod√©r√©e</h2>
<label>Combien de jours par semaine ?</label>
<input type="number" min="0" max="7" onchange="state.gpaq.lm_d=this.value">
<label>Combien de temps y consacrez-vous par jour ?</label>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.lm_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.lm_m=this.value">
<button class="btn" onclick="gpaqQ16()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,90);
}

function gpaqQ16(){
render(`
<h2>Comportement s√©dentaire</h2>
<p>Combien de temps passez-vous assis ou couch√© par jour (hors sommeil) ?</p>
<input type="number" placeholder="Heures" min="0" max="24" onchange="state.gpaq.sed_h=this.value">
<input type="number" placeholder="Minutes" min="0" max="59" onchange="state.gpaq.sed_m=this.value">
<button class="btn" onclick="finishGPAQ()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,95);
}

function finishGPAQ(){
  const toMin = (h,m)=> (h||0)*60+(m||0);
  const MET =
    toMin(state.gpaq.wi_h,state.gpaq.wi_m)*(state.gpaq.wi_d||0)*8 +
    toMin(state.gpaq.li_h,state.gpaq.li_m)*(state.gpaq.li_d||0)*8 +
    (
      toMin(state.gpaq.wm_h,state.gpaq.wm_m)*(state.gpaq.wm_d||0) +
      toMin(state.gpaq.tr_h,state.gpaq.tr_m)*(state.gpaq.tr_d||0) +
      toMin(state.gpaq.lm_h,state.gpaq.lm_m)*(state.gpaq.lm_d||0)
    )*4;

  state.result.met=MET;
  state.result.niveau=MET>=3000?"tr√®s_actif":MET>=600?"moyennement_actif":"insuffisamment_actif";
  motivation();
}

/*************************************************
 * STADE MOTIVATIONNEL (CORRIG√â)
 *************************************************/
function motivation(){
  if(state.result.niveau!=="insuffisamment_actif"){
    render(`
<p>√ätes-vous actif √† ce niveau depuis plus de 6 mois ?</p>
<button class="btn" onclick="state.result.stade='consolidation'; evaImportance()">Oui</button>
<button class="btn" onclick="state.result.stade='action'; evaImportance()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,97);
  } else {
    render(`
<p>Envisagez-vous d‚Äôaugmenter votre activit√© physique dans les 30 jours ?</p>
<button class="btn" onclick="state.result.stade='pr√©paration'; evaImportance()">Oui</button>
<button class="btn" onclick="motivation6mois()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,97);
  }
}

function motivation6mois(){
render(`
<p>Avez-vous l‚Äôintention de vous engager dans une activit√© physique r√©guli√®re dans les 6 mois ?</p>
<button class="btn" onclick="state.result.stade='intention'; evaImportance()">Oui</button>
<button class="btn" onclick="state.result.stade='ind√©termination'; evaImportance()">Non</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,98);
}

/*************************************************
 * EVA
 *************************************************/
function evaImportance(){
render(`
<p>Quelle importance accordez-vous √† l‚Äôactivit√© physique dans votre vie, entre 0 (aucune importance) et 10 (tr√®s grande importance) ?</p>
<input type="range" min="0" max="10" value="5" oninput="this.nextElementSibling.innerText=this.value">
<div>5</div>
<button class="btn" onclick="state.result.importance=document.querySelector('input').value; evaConfiance()">Continuer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,99);
}

function evaConfiance(){
render(`
<p>Dans quelle mesure √™tes-vous confiant(e) en vous pour r√©ussir √† augmenter, si besoin, votre niveau d‚Äôactivit√© physique ?</p>
<input type="range" min="0" max="10" value="5" oninput="this.nextElementSibling.innerText=this.value">
<div>5</div>
<button class="btn" onclick="state.result.confiance=document.querySelector('input').value; final()">Terminer</button>
<button class="btn secondary" onclick="back()">Retour</button>
`,100);
}

/*************************************************
 * FIN √âTAPE 2
 *************************************************/
<script>
function final(){

  const today = new Date().toISOString().split("T")[0];

  const medicalJSON = {
    outil: "auto_evaluation_AP",
    questionnaire: state.tool,
    date: today,
    niveau_activite: state.result.niveau,
    met_min_semaine: state.tool==="gpaq" ? Math.round(state.result.met) : null,
    marshall_score: state.tool==="marshall" ? state.result.marshall_score : null,
    stade_motivationnel: state.result.stade,
    eva_importance: Number(state.result.importance),
    eva_confiance: Number(state.result.confiance)
  };

  render(`
    <h2>Conclusion</h2>

    <p><strong>Niveau d‚Äôactivit√© :</strong>
      ${state.result.niveau.replace("_"," ")}
      ${state.result.met ? `(${Math.round(state.result.met)} MET-min/semaine)` : ""}
      ${state.result.marshall_score!==undefined ? `(score ${state.result.marshall_score})` : ""}
    </p>

    <p><strong>Stade motivationnel :</strong> ${state.result.stade}</p>
    <p><strong>Importance :</strong> ${state.result.importance}/10</p>
    <p><strong>Confiance :</strong> ${state.result.confiance}/10</p>

    <hr>

    <details>
      <summary><strong>üìÑ R√©sum√© m√©dical (pour le m√©decin)</strong></summary>

      <pre id="json">${JSON.stringify(medicalJSON,null,2)}</pre>

      <button class="btn"
        onclick="navigator.clipboard.writeText(document.getElementById('json').innerText)">
        Copier le JSON m√©dical
      </button>

      <button class="btn"
        onclick="envoyerMailJSON()">
        Envoyer au m√©decin par mail
      </button>
    </details>

    <button class="btn secondary" onclick="location.reload()">Recommencer</button>

    <p class="footer">
      Outil d‚Äôaide √† la consultation m√©dicale.
    </p>
  `,100,false);

  window.medicalJSON = medicalJSON;
}

function envoyerMailJSON(){
  const subject = encodeURIComponent("Auto-√©valuation activit√© physique");
  const body = encodeURIComponent(
    "Bonjour,\n\nVoici les donn√©es issues de l‚Äôauto-√©valuation d‚Äôactivit√© physique :\n\n" +
    JSON.stringify(window.medicalJSON,null,2)
  );
  window.location.href = `mailto:?subject=${subject}&body=${body}`;
}
</script>

