<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pr√©-consultation ‚Äì Activit√© Physique</title>
<style>
body { font-family: Arial, sans-serif; background:#f6f7f8; margin:0; }
.container { max-width:700px; margin:auto; padding:20px; background:white; min-height:100vh; }
h1,h2,h3 { font-weight:600; }
.btn { display:block; width:100%; padding:14px; margin:10px 0; font-size:16px; border-radius:6px; border:none; background:#007BFF; color:white; cursor:pointer; }
.btn.secondary { background:#6c757d; }
.btn:hover { background:#0056b3; }
.progress { height:6px; background:#ddd; margin:15px 0; }
.progress-bar { height:6px; width:0%; background:#4caf50; }
.question { margin-top:20px; }
input[type=number], input[type=text], input[type=range] { width:100%; padding:10px; font-size:16px; margin-top:10px; }
input[type=range] { margin-top:5px; }
.footer { font-size:12px; color:#666; margin-top:40px; }
pre { background:#f1f1f1; padding:10px; font-size:12px; overflow-x:auto; }
.rgpd-banner { font-size:12px; color:#555; margin-bottom:15px; }
</style>
</head>
<body>
<div class="container" id="app"></div>

<script>
/*************************************************
 * √âTAT GLOBAL
 *************************************************/
const state = {
  tool: null,
  gpaq: {},
  result: {},
  history: []
};

/*************************************************
 * RENDER
 *************************************************/
function render(html, progress=0, saveHistory=true){
  if(saveHistory) state.history.push(document.getElementById('app').innerHTML);
  document.getElementById('app').innerHTML = `
    <div class="progress"><div class="progress-bar" style="width:${progress}%"></div></div>
    ${html}
  `;
}

function goBack(){
  if(state.history.length>0){
    const previous = state.history.pop();
    document.getElementById('app').innerHTML = previous;
  }
}

/*************************************************
 * PAGE D'ACCUEIL
 *************************************************/
render(`
  <h1>Activit√© physique</h1>
  <p>Questionnaire destin√© √† pr√©parer votre consultation m√©dicale.<br>Aucune donn√©e n'est enregistr√©e.</p>
  <div class="rgpd-banner">
    Ce questionnaire est h√©berg√© sur GitHub et ne stocke pas vos donn√©es. Vous pouvez l'imprimer pour usage personnel ou m√©dical.
    <a href="#" target="_blank">Politique de confidentialit√©</a>
  </div>
  <button class="btn" onclick="start('gpaq')">Questionnaire d√©taill√© (GPAQ)</button>
  <button class="btn secondary" onclick="start('marshall')">Questionnaire court (Marshall)</button>
`);

function start(tool){
  state.tool = tool;
  state.result = {};
  state.gpaq = {};
  state.history = [];
  if(tool==='marshall') marshallQ1();
  else gpaqQ1();
}

/*************************************************
 * MARSHALL
 *************************************************/
function marshallQ1(){
  render(`
    <h2>Marshall ‚Äì Question 1</h2>
    <p>Combien de fois par semaine faites-vous ‚â•20 min d'activit√© intense ?</p>
    <button class="btn" onclick="state.result.marshall_q1=4; marshallQ2()">‚â•3 fois</button>
    <button class="btn" onclick="state.result.marshall_q1=2; marshallQ2()">1‚Äì2 fois</button>
    <button class="btn" onclick="state.result.marshall_q1=0; marshallQ2()">Jamais</button>
    <button class="btn secondary" onclick="goBack()">Retour</button>
  `,20);
}

function marshallQ2(){
  render(`
    <h2>Marshall ‚Äì Question 2</h2>
    <p>Combien de fois par semaine faites-vous ‚â•30 min d'activit√© mod√©r√©e ?</p>
    <button class="btn" onclick="finishMarshall(4)">‚â•5 fois</button>
    <button class="btn" onclick="finishMarshall(2)">3‚Äì4 fois</button>
    <button class="btn" onclick="finishMarshall(1)">1‚Äì2 fois</button>
    <button class="btn" onclick="finishMarshall(0)">Jamais</button>
    <button class="btn secondary" onclick="goBack()">Retour</button>
  `,40);
}

function finishMarshall(q2){
  const score = state.result.marshall_q1 + q2;
  state.result.niveau = score>=4 ? 'suffisamment_actif' : 'insuffisamment_actif';
  motivation();
}

/*************************************************
 * GPAQ COMPLET ‚Äì toutes sections
 *************************************************/
function gpaqQ1(){
  render(`
    <h2>Travail ‚Äì Activit√© intense</h2>
    <p>Votre travail implique-t-il des activit√©s physiques intenses ?</p>
    <button class="btn" onclick="state.gpaq.q1=1; gpaqQ2()">Oui</button>
    <button class="btn" onclick="state.gpaq.q1=0; gpaqQ4()">Non</button>
    <button class="btn secondary" onclick="goBack()">Retour</button>
  `,10);
}
function gpaqQ2(){ render(`<p>Combien de jours par semaine ?</p><input type="number" min="0" max="7" onchange="state.gpaq.q2=this.value"><button class="btn" onclick="gpaqQ3()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,20);}
function gpaqQ3(){ render(`<p>Temps par jour (minutes)</p><input type="number" min="0" max="1440" onchange="state.gpaq.q3=this.value"><button class="btn" onclick="gpaqQ4()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,30);}
function gpaqQ4(){ render(`<h2>Travail ‚Äì Activit√© mod√©r√©e</h2><p>Votre travail implique-t-il des activit√©s mod√©r√©es ?</p><button class="btn" onclick="state.gpaq.q4=1; gpaqQ5()">Oui</button><button class="btn" onclick="gpaqQ7()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,40);}
function gpaqQ5(){ render(`<p>Jours par semaine ?</p><input type="number" min="0" max="7" onchange="state.gpaq.q5=this.value"><button class="btn" onclick="gpaqQ6()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,50);}
function gpaqQ6(){ render(`<p>Temps par jour (minutes)</p><input type="number" min="0" max="1440" onchange="state.gpaq.q6=this.value"><button class="btn" onclick="gpaqQ7()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,60);}
function gpaqQ7(){ 
  render(`<h2>D√©placements</h2><p>Effectuez-vous des trajets √† pied ou √† v√©lo ‚â•10 min ?</p><button class="btn" onclick="state.gpaq.q7=1; gpaqQ8()">Oui</button><button class="btn" onclick="gpaqQ10()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,70);
}
function gpaqQ8(){ render(`<p>Combien de jours par semaine ?</p><input type="number" min="0" max="7" onchange="state.gpaq.q8=this.value"><button class="btn" onclick="gpaqQ9()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,75);}
function gpaqQ9(){ render(`<p>Temps par jour (minutes)</p><input type="number" min="0" max="1440" onchange="state.gpaq.q9=this.value"><button class="btn" onclick="gpaqQ10()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,80);}
function gpaqQ10(){ render(`<h2>Loisirs ‚Äì Activit√© intense</h2><p>Pratiquez-vous des sports ou fitness intenses ?</p><button class="btn" onclick="state.gpaq.q10=1; gpaqQ11()">Oui</button><button class="btn" onclick="gpaqQ13()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,85);}
function gpaqQ11(){ render(`<p>Jours par semaine ?</p><input type="number" min="0" max="7" onchange="state.gpaq.q11=this.value"><button class="btn" onclick="gpaqQ12()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,87);}
function gpaqQ12(){ render(`<p>Temps par jour (minutes)</p><input type="number" min="0" max="1440" onchange="state.gpaq.q12=this.value"><button class="btn" onclick="gpaqQ13()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,88);}
function gpaqQ13(){ render(`<h2>Loisirs ‚Äì Activit√© mod√©r√©e</h2><p>Pratiquez-vous des activit√©s mod√©r√©es ?</p><button class="btn" onclick="state.gpaq.q13=1; gpaqQ14()">Oui</button><button class="btn" onclick="gpaqQ16()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,89);}
function gpaqQ14(){ render(`<p>Jours par semaine ?</p><input type="number" min="0" max="7" onchange="state.gpaq.q14=this.value"><button class="btn" onclick="gpaqQ15()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,90);}
function gpaqQ15(){ render(`<p>Temps par jour (minutes)</p><input type="number" min="0" max="1440" onchange="state.gpaq.q15=this.value"><button class="btn" onclick="gpaqQ16()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,91);}
function gpaqQ16(){ render(`<h2>Comportement s√©dentaire</h2><p>Temps assis ou couch√© par jour (hors sommeil) ?</p><input type="number" min="0" max="1440" onchange="state.gpaq.q16=this.value"><button class="btn" onclick="finishGPAQ()">Terminer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,92);}
function finishGPAQ(){
  // Calcul MET-min
  const APim = (state.gpaq.q2||0)*(state.gpaq.q3||0);
  const APmm = (state.gpaq.q5||0)*(state.gpaq.q6||0) + (state.gpaq.q8||0)*(state.gpaq.q9||0) + (state.gpaq.q14||0)*(state.gpaq.q15||0);
  const APtS = APim*8 + APmm*4;
  const APij = (state.gpaq.q2||0) + (state.gpaq.q11||0);
const APmj = (state.gpaq.q5||0) + (state.gpaq.q8||0) + (state.gpaq.q14||0);
  const APtj = APij + APmj;

  if ((APij>=3 && APtS>=1500) || (APtj>=7 && APtS>=3000)) state.result.niveau='tr√®s_actif';
  else if ((APij>=3 && APim>=60) || (APmj>=5 && APmm>=150) || (APtj>=5 && APtS>=600)) state.result.niveau='moyennement_actif';
  else state.result.niveau='insuffisamment_actif';

  state.result.met = APtS;
  motivation();
}

/*************************************************
 * STADE MOTIVATIONNEL & EVA
 *************************************************/
function motivation(){
  if(state.result.niveau!=='insuffisamment_actif'){
    render(`<p>√ätes-vous actif √† ce niveau depuis plus de 6 mois ?</p><button class="btn" onclick="state.result.stade='consolidation'; evaImportance()">Oui</button><button class="btn" onclick="state.result.stade='action'; evaImportance()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,70);
  } else {
    render(`<p>Envisagez-vous d‚Äôaugmenter votre activit√© physique dans les 30 jours ?</p><button class="btn" onclick="state.result.stade='pr√©paration'; evaImportance()">Oui</button><button class="btn" onclick="motivation2()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,70);
  }
}
function motivation2(){
  render(`<p>Dans les 6 mois ?</p><button class="btn" onclick="state.result.stade='intention'; evaImportance()">Oui</button><button class="btn" onclick="state.result.stade='ind√©termination'; evaImportance()">Non</button><button class="btn secondary" onclick="goBack()">Retour</button>`,75);
}
function evaImportance(){
  render(`<p>Importance de l‚Äôactivit√© physique (0‚Äì10)</p><input type="range" min="0" max="10" value="5" oninput="this.nextElementSibling.innerText=this.value"><div>5</div><button class="btn" onclick="state.result.importance=document.querySelector('input').value; evaConfiance()">Continuer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,85);
}
function evaConfiance(){
  render(`<p>Confiance pour maintenir ou augmenter votre activit√© (0‚Äì10)</p><input type="range" min="0" max="10" value="5" oninput="this.nextElementSibling.innerText=this.value"><div>5</div><button class="btn" onclick="state.result.confiance=document.querySelector('input').value; resultat()">Terminer</button><button class="btn secondary" onclick="goBack()">Retour</button>`,90);
}

/*************************************************
 * R√âSULTATS PATIENT / M√âDICAL + EXPORT
 *************************************************/
function resultat(){
  const dateNow = new Date().toLocaleDateString();
  const medical = {
    outil: 'AP_preconsultation',
    version: '1.0',
    questionnaire: state.tool,
    date: dateNow,
    niveau_activite: state.result.niveau,
    met_min_semaine_total: state.result.met,
    stade_motivationnel: state.result.stade,
    importance_ap: state.result.importance,
    confiance_ap: state.result.confiance
  };

  const patientText = `Votre niveau d‚Äôactivit√© physique semble ${state.result.niveau.replace('_',' ')}${state.result.met?` (${state.result.met} MET-min/semaine)`:''}.\nCe questionnaire a pour objectif de pr√©parer un √©change avec votre m√©decin.`;

  render(`
    <h2>R√©sultat patient</h2>
    <p>${patientText}</p>
    <h3>R√©sum√© m√©dical (structur√©)</h3>
    <pre id="json">${JSON.stringify(medical,null,2)}</pre>
    <button class="btn" onclick="navigator.clipboard.writeText(document.getElementById('json').innerText)">Copier le r√©sum√© m√©dical</button>
    <button class="btn" onclick="window.print()">Exporter en PDF</button>
    <button class="btn" onclick="envoyerMail()">Envoyer par mail</button>
    <button class="btn secondary" onclick="goBack()">Retour</button>
    <p class="footer">Cet outil a pour objectif de pr√©parer un √©change avec votre m√©decin.</p>
  `,100,false);
}

function envoyerMail(){
  const patientText = `Questionnaire activit√© physique ‚Äì pr√©-consultation.\n\nMerci de copier-coller le r√©sum√© m√©dical ci-dessous dans votre outil.`;

  const json = document.getElementById('json').innerText;

  // 1Ô∏è‚É£ Copier le JSON automatiquement
  navigator.clipboard.writeText(json).then(() => {
    // 2Ô∏è‚É£ Mail court et s√ªr
    const subject = encodeURIComponent("Questionnaire activit√© physique");
    const body = encodeURIComponent(
      patientText +
      "\n\nüëâ Le r√©sum√© m√©dical a √©t√© COPI√â automatiquement dans le presse-papier."
    );

    window.location.href = `mailto:?subject=${subject}&body=${body}`;
  }).catch(() => {
    alert("Impossible de copier automatiquement. Vous pouvez copier manuellement le r√©sum√© m√©dical.");
  });
}

</script>
</body>
</html>
