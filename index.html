<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pré-consultation – Activité Physique</title>

<style>
body { font-family: Arial, sans-serif; background:#f6f7f8; margin:0; }
.container { max-width:700px; margin:auto; padding:20px; background:white; min-height:100vh; }
h1,h2,h3 { font-weight:600; }
.btn { display:block; width:100%; padding:14px; margin:10px 0; font-size:16px; border-radius:6px; border:none; background:#007BFF; color:white; cursor:pointer; }
.btn.secondary { background:#6c757d; }
.btn:hover { background:#0056b3; }
.progress { height:6px; background:#ddd; margin:15px 0; }
.progress-bar { height:6px; background:#4caf50; }
input[type=number], input[type=range] { width:100%; padding:10px; font-size:16px; margin-top:10px; }
.footer { font-size:12px; color:#666; margin-top:40px; }
.rgpd-banner { font-size:12px; color:#555; margin-bottom:15px; }
</style>
</head>

<body>
<div class="container" id="app"></div>

<script>
/*************************************************
 * ÉTAT GLOBAL STRUCTURÉ
 *************************************************/
const state = {
  tool: null,
  gpaq: {},
  result: {},
  reponses: {},
  synthese: {},
  exportCR: {},
  history: []
};

/*************************************************
 * RENDER & NAVIGATION
 *************************************************/
function render(html, progress=0){
  state.history.push(document.getElementById('app').innerHTML);
  document.getElementById('app').innerHTML = `
    <div class="progress">
      <div class="progress-bar" style="width:${progress}%"></div>
    </div>
    ${html}
  `;
}
function goBack(){
  if(state.history.length>0){
    document.getElementById('app').innerHTML = state.history.pop();
  }
}

/*************************************************
 * ACCUEIL
 *************************************************/
render(`
<h1>Activité physique</h1>
<p>Questionnaire destiné à préparer votre consultation médicale.<br>Aucune donnée n'est enregistrée.</p>

<div class="rgpd-banner">
  Ce questionnaire est hébergé sur GitHub Pages et ne stocke aucune donnée personnelle.
  <a href="https://abbe-web.github.io/Questionnaire-AutoEvaluation-AP/politique-confidentialite.html"
     target="_blank" rel="noopener noreferrer">Politique de confidentialité</a>
</div>

<button class="btn" onclick="start('gpaq')">Questionnaire détaillé (GPAQ)</button>
<button class="btn secondary" onclick="start('marshall')">Questionnaire court (Marshall)</button>
`,0);

/*************************************************
 * DÉMARRAGE
 *************************************************/
function start(tool){
  state.tool = tool;
  state.gpaq = {};
  state.result = {};
  state.reponses = {};
  state.synthese = {};
  state.exportCR = {};
  state.history = [];
  tool === 'marshall' ? marshallQ1() : gpaqQ1();
}

/*************************************************
 * MARSHALL
 *************************************************/
function marshallQ1(){
  render(`
    <h2>Marshall – Question 1</h2>
    <p>≥20 min d’activité intense ?</p>
    <button class="btn" onclick="state.result.q1=4; marshallQ2()">≥3 fois</button>
    <button class="btn" onclick="state.result.q1=2; marshallQ2()">1–2 fois</button>
    <button class="btn" onclick="state.result.q1=0; marshallQ2()">Jamais</button>
  `,20);
}
function marshallQ2(){
  render(`
    <h2>Marshall – Question 2</h2>
    <p>≥30 min d’activité modérée ?</p>
    <button class="btn" onclick="finishMarshall(4)">≥5 fois</button>
    <button class="btn" onclick="finishMarshall(2)">3–4 fois</button>
    <button class="btn" onclick="finishMarshall(1)">1–2 fois</button>
    <button class="btn" onclick="finishMarshall(0)">Jamais</button>
  `,40);
}
function finishMarshall(q2){
  const score = state.result.q1 + q2;
  state.reponses = { questionnaire:"marshall", score };
  state.synthese.niveau = score>=4 ? "suffisamment actif" : "insuffisamment actif";
  motivation();
}

/*************************************************
 * GPAQ – CALCUL OMS EXACT
 *************************************************/
function finishGPAQ(){
  const APim =
    (state.gpaq.q2||0)*(state.gpaq.q3||0) +
    (state.gpaq.q11||0)*(state.gpaq.q12||0);

  const APmm =
    (state.gpaq.q5||0)*(state.gpaq.q6||0) +
    (state.gpaq.q8||0)*(state.gpaq.q9||0) +
    (state.gpaq.q14||0)*(state.gpaq.q15||0);

  const MET = APim*8 + APmm*4;

  let niveau =
    MET>=3000 ? "très actif" :
    MET>=600  ? "moyennement actif" :
                "insuffisamment actif";

  state.synthese = { niveau, MET };

  state.reponses = {
    questionnaire:"gpaq",
    travail_intense:{jours:state.gpaq.q2||0,min:state.gpaq.q3||0},
    travail_modere:{jours:state.gpaq.q5||0,min:state.gpaq.q6||0},
    deplacements:{jours:state.gpaq.q8||0,min:state.gpaq.q9||0},
    loisirs_intense:{jours:state.gpaq.q11||0,min:state.gpaq.q12||0},
    loisirs_modere:{jours:state.gpaq.q14||0,min:state.gpaq.q15||0},
    sedentarite_min_jour:state.gpaq.q16||0
  };

  motivation();
}

/*************************************************
 * MOTIVATION + EVA
 *************************************************/
function motivation(){
  if(state.synthese.niveau!=="insuffisamment actif"){
    render(`
      <p>Êtes-vous actif à ce niveau depuis plus de 6 mois ?</p>
      <button class="btn" onclick="state.synthese.stade='consolidation'; evaI()">Oui</button>
      <button class="btn" onclick="state.synthese.stade='action'; evaI()">Non</button>
    `,70);
  } else {
    render(`
      <p>Augmenter votre activité dans les 30 jours ?</p>
      <button class="btn" onclick="state.synthese.stade='préparation'; evaI()">Oui</button>
      <button class="btn" onclick="state.synthese.stade='indétermination'; evaI()">Non</button>
    `,70);
  }
}
function evaI(){
  render(`
    <p>Importance (0–10)</p>
    <input type="range" min="0" max="10" value="5"
      oninput="this.nextElementSibling.innerText=this.value">
    <div>5</div>
    <button class="btn" onclick="state.synthese.importance=document.querySelector('input').value; evaC()">Continuer</button>
  `,85);
}
function evaC(){
  render(`
    <p>Confiance (0–10)</p>
    <input type="range" min="0" max="10" value="5"
      oninput="this.nextElementSibling.innerText=this.value">
    <div>5</div>
    <button class="btn" onclick="state.synthese.confiance=document.querySelector('input').value; resultat()">Terminer</button>
  `,90);
}

/*************************************************
 * AFFICHAGE CLINIQUE + EXPORT CR
 *************************************************/
function resultat(){
  state.exportCR = {
    questionnaire: state.tool,
    niveau_activite: state.synthese.niveau,
    met_min_semaine_total: state.synthese.MET || null,
    stade_motivationnel: state.synthese.stade,
    importance_ap: state.synthese.importance,
    confiance_ap: state.synthese.confiance
  };

  render(`
    <h2>Conclusion</h2>
    <p><strong>${state.synthese.niveau}</strong>
    ${state.synthese.MET?`(${state.synthese.MET} MET-min/semaine)`:''}</p>

    <h3>Détail des réponses</h3>
    <pre>${JSON.stringify(state.reponses,null,2)}</pre>

    <button class="btn" onclick="exportCR()">Exporter vers le compte rendu médical</button>
    <button class="btn secondary" onclick="window.print()">Imprimer</button>

    <p class="footer">Outil d’aide à la discussion – ne remplace pas un avis médical.</p>
  `,100);
}

function exportCR(){
  navigator.clipboard.writeText(JSON.stringify(state.exportCR,null,2))
    .then(()=>alert("Résumé médical copié dans le presse-papiers."));
}
</script>
</body>
</html>
